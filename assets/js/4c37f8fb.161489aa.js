"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[276],{167:(e,i,n)=>{n.d(i,{A:()=>t});const t=n.p+"assets/images/002.both-20f24c4ca0628ec47f5bda183083203f.png"},811:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"arcturus/ADP","title":"ADP","description":"This document describes the ADP file format used in Arcturus.","source":"@site/docs/arcturus/ADP.md","sourceDirName":"arcturus","slug":"/file-formats/adp","permalink":"/file-formats/adp","draft":false,"unlisted":false,"editUrl":"https://github.com/RagnarokResearchLab/ragnarokresearchlab.github.io/edit/main/docs/arcturus/ADP.md","tags":[],"version":"current","frontMatter":{"slug":"/file-formats/adp","title":"ADP"},"sidebar":"tutorialSidebar","previous":{"title":"Overview","permalink":"/arcturus"},"next":{"title":"INI (Placeholder)","permalink":"/file-formats/ini"}}');var s=n(4848),a=n(8453);const r={slug:"/file-formats/adp",title:"ADP"},o=void 0,l={},d=[{value:"Contents",id:"contents",level:2},{value:"Layout",id:"layout",level:2},{value:"Versions",id:"versions",level:3},{value:"Fields",id:"fields",level:3},{value:"StartingOffset",id:"startingoffset",level:4},{value:"NumSamplesPerSecond",id:"numsamplespersecond",level:4},{value:"NumInterleavedAudioChannels",id:"numinterleavedaudiochannels",level:4},{value:"AudioStreamSizeInBytes",id:"audiostreamsizeinbytes",level:4},{value:"Compressed Audio Stream",id:"compressed-audio-stream",level:4},{value:"ADPCM Compression",id:"adpcm-compression",level:2},{value:"IMA ADPCM Codec",id:"ima-adpcm-codec",level:3},{value:"Open Questions",id:"open-questions",level:2}];function c(e){const i={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(i.p,{children:"This document describes the ADP file format used in Arcturus."}),"\n",(0,s.jsx)(i.h2,{id:"contents",children:"Contents"}),"\n",(0,s.jsx)(i.p,{children:"ADP files contain compressed audio samples for the game's background music tracks."}),"\n",(0,s.jsx)(i.h2,{id:"layout",children:"Layout"}),"\n",(0,s.jsx)(i.h3,{id:"versions",children:"Versions"}),"\n",(0,s.jsx)(i.p,{children:"Each file encodes a sequence of interleaved stereo (i.e., two-channel) audio samples, preceded by a magic header:"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-cpp",metastring:'title="ADP File Format (Arcturus)"',children:"struct ArcturusADP {\n    uint32_t StartingOffset;\n    uint32_t NumSamplesPerSecond;\n    uint32_t NumInterleavedAudioChannels;\n    uint32_t AudioStreamSizeInBytes;\n    uint8_t* CompressedAudioStream;\n};\n"})}),"\n",(0,s.jsx)(i.h3,{id:"fields",children:"Fields"}),"\n",(0,s.jsx)(i.h4,{id:"startingoffset",children:"StartingOffset"}),"\n",(0,s.jsxs)(i.p,{children:["Appears to simply be the size of the header, which is the offset to the ADPCM-compressed audio stream. Always ",(0,s.jsx)(i.code,{children:"16"}),"."]}),"\n",(0,s.jsx)(i.h4,{id:"numsamplespersecond",children:"NumSamplesPerSecond"}),"\n",(0,s.jsxs)(i.p,{children:["The playback speed (technically: ",(0,s.jsx)(i.a,{href:"https://en.m.wikipedia.org/wiki/Sampling_(signal_processing)#Sampling_rate",children:"sampling rate"}),"). Once decoded, this many samples should be rendered per second. Always ",(0,s.jsx)(i.code,{children:"22050"}),", which matches the 44.1 kHz sampling rate typically used for ",(0,s.jsx)(i.a,{href:"https://en.m.wikipedia.org/wiki/Compact_Disc_Digital_Audio",children:"Audio CDs"}),". Each ",(0,s.jsx)(i.code,{children:"int16_t"})," sample takes up two bytes."]}),"\n",(0,s.jsx)(i.h4,{id:"numinterleavedaudiochannels",children:"NumInterleavedAudioChannels"}),"\n",(0,s.jsxs)(i.p,{children:["How many channels can be found in the ADPCM-encoded audio stream. Always ",(0,s.jsx)(i.code,{children:"2"})," (for stereo = alternating left/right)."]}),"\n",(0,s.jsx)(i.h4,{id:"audiostreamsizeinbytes",children:"AudioStreamSizeInBytes"}),"\n",(0,s.jsxs)(i.p,{children:["How many bytes can be extracted from the ADPCM-encoded audio stream. Represents the distance until ",(0,s.jsx)(i.code,{children:"EOF"}),"."]}),"\n",(0,s.jsx)(i.h4,{id:"compressed-audio-stream",children:"Compressed Audio Stream"}),"\n",(0,s.jsxs)(i.p,{children:["ADPCM-encoded 4-bit audio samples. For stereo streams, each byte corresponds to a single (",(0,s.jsx)(i.code,{children:"LEFT"}),", ",(0,s.jsx)(i.code,{children:"RIGHT"}),") audio sample."]}),"\n",(0,s.jsx)(i.h2,{id:"adpcm-compression",children:"ADPCM Compression"}),"\n",(0,s.jsxs)(i.p,{children:["ADP files contain audio samples that have been encoded with an implementation of the ",(0,s.jsx)(i.a,{href:"https://en.wikipedia.org/wiki/Adaptive_differential_pulse-code_modulation",children:"ADPCM"})," compression algorithm."]}),"\n",(0,s.jsx)(i.p,{children:'ADPCM is an audio compression scheme that works by predicting the shape of an encoded audio signal, the "waveform" - one per channel - based on an initial state (presumably, all zeroes in this case). It is adaptive in the sense that each new 4-bit sample modifies the state of the predictor and thereby influences how the remainder of the audio stream should be interpreted.'}),"\n",(0,s.jsx)(i.p,{children:"This means that even slight errors propagate and accumulate over time, leading to audible artifacts like white noise, crackling, unexpected volume changes, or other unpleasant disturbances in the output signal. For that reason, it is critical to get all of the details right (and, if you're implementing a decoder, take precautions to protect your hearing whilst debugging)."}),"\n",(0,s.jsx)(i.h3,{id:"ima-adpcm-codec",children:"IMA ADPCM Codec"}),"\n",(0,s.jsxs)(i.p,{children:["There are many variants of the ADPCM algorithm. The one implemented in the game appears to be based on the official ",(0,s.jsx)(i.a,{href:"http://www.cs.columbia.edu/~hgs/audio/dvi/IMA_ADPCM.pdf",children:"IMA ADPCM specification"}),". In this version, lookup tables were originally introduced to allow replacing expensive floating-point ops with bit-shifts and integer arithmetic. Unfortunately, this introduces a layer of indirection that may obscure the core idea behind the algorithm. It is however explained in the specification for the ",(0,s.jsx)(i.a,{href:"https://en.wikipedia.org/wiki/Dialogic_ADPCM",children:"Dialogic/OKI ADPCM"})," codec (archived ",(0,s.jsx)(i.a,{href:"https://web.archive.org/web/20061118115218/http://www.salina.k-state.edu/faculty/tim/vox/dialogic_adpcm.pdf",children:"here"}),")."]}),"\n",(0,s.jsxs)(i.p,{children:["Luckily, the IMA specification does include a reference implementation. From ",(0,s.jsx)(i.code,{children:"6.2. 4-bit ADPCM to 16-bit Linear Decompression"}),":"]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-cpp",metastring:'title="Preinitialized variables"',children:" index = 0;\n stepsize = 7;\n /* output of ADPCM predictor */\n /* index into stepsizeTable */\n /* quantizer stepsize */\n indexTable[16] = {\u20131,\u20131,\u20131,\u20131, 2, 4, 6, 8, /* Table of index changes */\n  \u20131,\u20131,\u20131,\u20131, 2, 4, 6, 8);\n stepsizeTable[89] = {7, 8, 9, 10, 11, 12, 13, /* quantizer lookup table */\n 14, 16, 17, 19, 21, 23, 25, 28,\n 31, 34, 37, 41, 45, 50, 55, 60,\n66, 73, 80, 88, 97, 107, 118,\n130, 143, 157, 173, 190, 209, 230,\n253, 279, 307, 337, 371, 408, 449,\n494, 544, 598, 658, 724, 796, 876,\n963, 1060, 1166, 1282, 1411, 1552,\n1707, 1878, 2066, 2272, 2499, 2749,\n3024, 3327, 3660, 4026, 4428, 4871,\n5358, 5894, 6484, 7132, 7845, 8630,\n9493, 10442, 11487, 12635, 13899,\n15289, 16818, 18500, 20350, 22385,\n24623, 27086, 29794, 32767);\n"})}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-cpp",metastring:'title="Calculation for each sample"',children:"/* compute predicted sample estimate newSample */\n /* calculate difference = (originalSample + \xbd) * stepsize/4: */\n difference = 0;\n if (originalSample & 4)\n /* perform multiplication through repetitive addition */\n difference + = stepsize;\n if (originalSample & 2)\n difference + = stepsize >> 1;\n if (originalSample & 1)\n difference + = stepsize >> 2;\n /* (originalSample + \xbd) * stepsize/4 =originalSample * stepsize/4 + stepsize/8: */\n difference + = stepsize >> 3;\n if (originalSample & 8)\n /* account for sign bit */\n difference = \u2013difference;\n /* adjust predicted sample based on calculated difference: */\n newSample + = difference;\n if (newSample > 32767)\n /* check for overflow */\n newSample = 32767;\n else if (newSample < \u201332768)\n newSample = \u201332768;\n /* 16-bit newSample can be stored at this point */\n /* compute new stepsize */\n /*adjust index into stepsize lookup table using originalSample: */\n index + = indexTable[originalSample];\n if (index < 0)\n /* check for index underflow */\n index = 0;\n else if (index > 88)\n index = 88;\n stepsize = stepsizeTable[index];\n"})}),"\n",(0,s.jsx)(i.p,{children:"Note that the examples following this description aren't quite correct, and have therefore been omitted from this document."}),"\n",(0,s.jsx)(i.h2,{id:"open-questions",children:"Open Questions"}),"\n",(0,s.jsx)(i.p,{children:"Several details still need to be investigated:"}),"\n",(0,s.jsxs)(i.ol,{children:["\n",(0,s.jsx)(i.li,{children:"It's unclear whether the predictor is in fact seeded; it didn't seem to make a noticeable difference in my testing"}),"\n",(0,s.jsx)(i.li,{children:"Samples should be hard-clipped whenever they exceed the 16-bit range, although this will at times sound jarring"}),"\n",(0,s.jsx)(i.li,{children:"Compared to the MP3 version of the game's soundtrack, the ADP version generally seems inferior in quality"}),"\n",(0,s.jsx)(i.li,{children:"Whether or not the game modifies the samples before playing them back might be worth looking into as well"}),"\n",(0,s.jsx)(i.li,{children:"A side-by-side comparison for each track to the actual ingame audio (or YouTube videos/recordings) could help"}),"\n"]}),"\n",(0,s.jsx)(i.p,{children:"It's possible to generate outputs that closely resemble the official OST waveform. However, a few discrepancies remain:"}),"\n",(0,s.jsxs)(i.p,{children:[(0,s.jsx)(i.img,{alt:"ADPCM/MP3 Waveform (Comparison)",src:n(167).A+"",width:"4096",height:"2048"}),"\n",(0,s.jsxs)(i.em,{children:["IMA-decoded ADPCM waveform (red) overlaid with raw MP3 samples from the second OST music track, titled ",(0,s.jsx)(i.a,{href:"https://www.youtube.com/watch?v=8GdjFGFGOBc",children:'"The Innocents"'}),"."]})]}),"\n",(0,s.jsx)(i.admonition,{type:"info",children:(0,s.jsxs)(i.p,{children:["Waveform visualizations for other tracks can be found ",(0,s.jsx)(i.a,{href:"https://valkyrie-realm.net/research/file-formats/adp/samples/",children:"here"}),". Generating them locally instead is highly recommended."]})}),"\n",(0,s.jsx)(i.p,{children:"Whether or not these discrepancies are solely due to the use of different compression schemes remains to be seen."})]})}function h(e={}){const{wrapper:i}={...(0,a.R)(),...e.components};return i?(0,s.jsx)(i,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},8453:(e,i,n)=>{n.d(i,{R:()=>r,x:()=>o});var t=n(6540);const s={},a=t.createContext(s);function r(e){const i=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(i):{...i,...e}},[i,e])}function o(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),t.createElement(a.Provider,{value:i},e.children)}}}]);