<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-rendering/scene-lighting" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">Scene Lighting | Ragnarok Research Lab</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ragnarokresearchlab.github.io/rendering/scene-lighting/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Scene Lighting | Ragnarok Research Lab"><meta data-rh="true" name="description" content="This document describes the lighting model used by the Ragnarok Online client."><meta data-rh="true" property="og:description" content="This document describes the lighting model used by the Ragnarok Online client."><link data-rh="true" rel="icon" href="/img/favicon-with-transparency.png"><link data-rh="true" rel="canonical" href="https://ragnarokresearchlab.github.io/rendering/scene-lighting/"><link data-rh="true" rel="alternate" href="https://ragnarokresearchlab.github.io/rendering/scene-lighting/" hreflang="en"><link data-rh="true" rel="alternate" href="https://ragnarokresearchlab.github.io/rendering/scene-lighting/" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.15fa3985.css">
<script src="/assets/js/runtime~main.2f69f9a8.js" defer="defer"></script>
<script src="/assets/js/main.ca17df43.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo-with-more-space-around.png" alt="Ragnarok Research Lab Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo-with-more-space-around.png" alt="Ragnarok Research Lab Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Ragnarok Research Lab</b></a><a class="navbar__item navbar__link" href="/about/">About</a><a class="navbar__item navbar__link" href="/file-formats/">File Formats</a><a class="navbar__item navbar__link" href="/rendering/">Rendering</a><a class="navbar__item navbar__link" href="/game-mechanics/">Game Mechanics</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/contributing/">Contribute</a><a href="https://discord.gg/7RFdMNrySy" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/RagnarokResearchLab" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/about/">About</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/contributing/">Contributing</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/file-formats/">File Formats</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/rendering/">Rendering</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rendering/">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rendering/coordinate-systems/">Coordinate Systems</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rendering/ground-mesh/">Ground Mesh</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rendering/camera-controls/">Camera Controls</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/rendering/scene-lighting/">Scene Lighting</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rendering/animation-systems/">Animation Systems</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/game-mechanics/">Game Mechanics</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/arcturus/">Arcturus</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/community-projects/">Community Projects</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/glossary/">Glossary</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Rendering</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Scene Lighting</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Scene Lighting</h1></header><p>This document describes the lighting model used by the Ragnarok Online client.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2>
<p>Several inputs contribute to the final color sent to the display device:</p>
<ul>
<li>The geometry itself defines the initial <a href="https://gamedev.stackexchange.com/questions/139059/what-is-a-vertex-color" target="_blank" rel="noopener noreferrer">vertex color</a> for each textured surface, as well as a <a href="https://en.wikipedia.org/wiki/Vertex_normal" target="_blank" rel="noopener noreferrer">vertex normal</a></li>
<li>One global <a href="https://en.wikipedia.org/wiki/Shading#Ambient_lighting" target="_blank" rel="noopener noreferrer">ambient light source</a> can be configured, which controls the general &quot;brightness&quot; level of the scene</li>
<li>A single <a href="https://en.wikipedia.org/wiki/Shading#Directional_lighting" target="_blank" rel="noopener noreferrer">directional light source</a> is always present; it can be thought of as &quot;the sun&quot;, casting shadows onto the map</li>
<li><a href="https://en.wikipedia.org/wiki/Texture_mapping" target="_blank" rel="noopener noreferrer">Diffuse textures</a> (also known as color maps) add detail to the geometry, or even 2D objects like sprites and effects</li>
<li>Dynamic light sources, here stored in precomputed <a href="https://en.wikipedia.org/wiki/Lightmap" target="_blank" rel="noopener noreferrer">lightmap textures</a>, additionally contribute to the lighting</li>
<li>If enabled, the engine&#x27;s <a href="https://learn.microsoft.com/en-us/windows/win32/direct3d9/vertex-fog#range-based-fog" target="_blank" rel="noopener noreferrer">vertex fog effect</a> will be used to apply color-grading according to the fog parameters</li>
</ul>
<p>The following sections explain how an accurate rendition of the game world can be produced from all of the above.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="pipeline-stages">Pipeline Stages<a href="#pipeline-stages" class="hash-link" aria-label="Direct link to Pipeline Stages" title="Direct link to Pipeline Stages">​</a></h2>
<p>Not all objects in the world are affected by light equally. This can be expressed in terms of <a href="https://en.wikipedia.org/wiki/Fixed-function" target="_blank" rel="noopener noreferrer">fixed-function pipeline</a> stages:</p>
<table><thead><tr><th style="text-align:center">Object Type</th><th style="text-align:center">Lighting</th><th style="text-align:center">Diffuse Texture Blending</th><th style="text-align:center">Lightmap Texture Blending</th><th style="text-align:center">Vertex Fog</th><th style="text-align:center">Alpha Blending</th></tr></thead><tbody><tr><td style="text-align:center">Ground</td><td style="text-align:center">YES</td><td style="text-align:center">YES</td><td style="text-align:center">YES</td><td style="text-align:center">YES</td><td style="text-align:center">NO</td></tr><tr><td style="text-align:center">Water</td><td style="text-align:center">NO</td><td style="text-align:center">YES</td><td style="text-align:center">NO</td><td style="text-align:center">YES</td><td style="text-align:center">YES</td></tr></tbody></table>
<p>The list is currently incomplete; more research is needed on the remaining object types. Some educated guesses:</p>
<ul>
<li>Models: Diffuse, lighting, vertex fog, alpha blend stages are enabled - lightmap contribution is TBD</li>
<li>Sprites: Diffuse, vertex fog, alpha blend stages are likely enabled - lightmap contribution is TBD</li>
<li>UI widgets: Diffuse, alpha blend stages are likely enabled - everything else is probably disabled</li>
</ul>
<p>There may be other game objects that use different settings, but these should be the most important ones.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="input-variables">Input Variables<a href="#input-variables" class="hash-link" aria-label="Direct link to Input Variables" title="Direct link to Input Variables">​</a></h2>
<p>The operations performed as part of a given pipeline stage may depend on various inputs:</p>
<ul>
<li>The base color is always interpolated from the fragment&#x27;s vertex color and defaults to black, i.e., <code>rgb(0, 0, 0)</code></li>
<li>To increase the vibrancy of colors, both ambient and directional light colors must be <a href="https://en.wikipedia.org/wiki/Blend_modes#Screen" target="_blank" rel="noopener noreferrer">screen blended</a> with the base color</li>
<li>Next, the total light contribution can be computed using the directional and ambient light&#x27;s setting and the vertex normal</li>
<li>Diffuse textures are modulated (multiplied) with the result of the previous stage, presumably while ignoring alpha?</li>
<li>The alpha channel of the lightmap texture (&quot;shadowmap&quot;) is first modulated with the result of the previous stage</li>
<li>Afterwards, the RGB channel of the lightmap texture (&quot;color map&quot;) is added on top of this result, and possibly clamped?</li>
<li>Vertex fog contributes its color based on the distance from the vertex to the camera&#x27;s viewpoint, linearly interpolated</li>
<li>Finally, the generated fragment may be layered on top (via <a href="https://en.wikipedia.org/wiki/Alpha_compositing" target="_blank" rel="noopener noreferrer">alpha compositing</a>) in accordance with the selected blend mode</li>
</ul>
<p>How those operations are implemented depends on the graphics API. DirectX7 uses <a href="https://learn.microsoft.com/en-us/windows/win32/direct3d9/render-states" target="_blank" rel="noopener noreferrer">render states</a> and <a href="https://learn.microsoft.com/en-us/windows/win32/direct3d9/creating-blending-stages" target="_blank" rel="noopener noreferrer">blending stages</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="lighting-stage">Lighting Stage<a href="#lighting-stage" class="hash-link" aria-label="Direct link to Lighting Stage" title="Direct link to Lighting Stage">​</a></h2>
<p>Computes the lit base color, corrected for <a href="https://www.adobe.com/creativecloud/photography/hub/guides/underexposure-vs-overexposure-photography.html" target="_blank" rel="noopener noreferrer">underexposure</a> that&#x27;s being introduced due to working in the wrong color space.</p>
<p>Inputs:</p>
<ul>
<li>Directional light settings from the map&#x27;s <a href="/file-formats/rsw/">RSW</a> file</li>
<li>Ambient light settings from the map&#x27;s <a href="/file-formats/rsw/">RSW</a> file</li>
<li>Vertex color and surface normals derived from the <a href="/file-formats/gnd/">GND</a>, <a href="/file-formats/rsm/">RSM</a>, or <a href="/file-formats/gr2/">GR2</a> file</li>
</ul>
<p>Operations:</p>
<ol>
<li>Compute sunlight contribution from the directional light settings</li>
<li>Add ambient light contribution from the ambient light settings</li>
<li>Clamp result to the unit range (in order to avoid overexposure)</li>
<li>Compute contrast correction color using <a href="https://affinityspotlight.com/article/blend-modes-explained/" target="_blank" rel="noopener noreferrer">Screen</a> blending</li>
<li>Modulate the previous result with the contrast correction color</li>
</ol>
<p>Specular highlights are disabled and needn&#x27;t be added.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="directional-light">Directional Light<a href="#directional-light" class="hash-link" aria-label="Direct link to Directional Light" title="Direct link to Directional Light">​</a></h3>
<p>The ray direction of the sun can be calculated from its world position, stored as <a href="https://en.wikipedia.org/wiki/Spherical_coordinate_system" target="_blank" rel="noopener noreferrer">spherical coordinates</a> in the <a href="/file-formats/rsw/">RSW</a> file:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> RagnarokRSW</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">ComputeSunRayDirection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">latitudeInDegrees</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> longitudeInDegrees</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">local</span><span class="token plain"> sunRayDirection </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Vector3D</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">local</span><span class="token plain"> rotationAroundX </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Matrix3D</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">CreateAxisRotationX</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">latitudeInDegrees</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- Account for inverted Y</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">local</span><span class="token plain"> rotationAroundY </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Matrix3D</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">CreateAxisRotationY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">longitudeInDegrees</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	sunRayDirection</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">Transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rotationAroundX</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	sunRayDirection</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">Transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rotationAroundY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> sunRayDirection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><em>Source: Example implementation taken from the <a href="https://github.com/RagnarokResearchLab/RagLite/blob/0bc2856e2acebcbb568b095853180574a78dc4ba/Core/FileFormats/RagnarokRSW.lua#L246-L256" target="_blank" rel="noopener noreferrer">RagLite SDK</a> (based on previous work by <a href="https://github.com/Borf" target="_blank" rel="noopener noreferrer">Borf</a> and <a href="https://github.com/flaviojs/" target="_blank" rel="noopener noreferrer">FlavioJS</a>)</em></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ambient-light">Ambient Light<a href="#ambient-light" class="hash-link" aria-label="Direct link to Ambient Light" title="Direct link to Ambient Light">​</a></h3>
<p>If lightmaps are disabled, the ambient scene lighting is amplified by a factor of 50% (multiply color components by 1.5).</p>
<p>This serves as an optional &quot;brightness correction&quot; step that only takes place when lightmaps are disabled on load.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="dynamic-lights">Dynamic Lights<a href="#dynamic-lights" class="hash-link" aria-label="Direct link to Dynamic Lights" title="Direct link to Dynamic Lights">​</a></h3>
<p>The <a href="/file-formats/rsw/">RSW</a> file of each map contains definitions for the dynamic light sources in the scene. However, they aren&#x27;t rendered by the client in real time. Instead, the game uses pre-computed <a href="https://en.wikipedia.org/wiki/Lightmap" target="_blank" rel="noopener noreferrer">lightmap</a> textures which can be blended with the terrain geometry more efficiently at runtime. Since the lights don&#x27;t directly contribute to the scene lighting, I won&#x27;t discuss them in detail here.</p>
<p>If you&#x27;re interested in how they can be used for dynamic lighting, you should check out <a href="https://youtu.be/VKywJ0QtcFE?t=561" target="_blank" rel="noopener noreferrer">Doddler&#x27;s explanation on YouTube</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="contrast-correction">Contrast Correction<a href="#contrast-correction" class="hash-link" aria-label="Direct link to Contrast Correction" title="Direct link to Contrast Correction">​</a></h3>
<p>When rendering the scene with just the ambient and directional light sources contributing alongside the diffuse or lightmap textures, the resulting image is severly underexposed. This is likely because lighting computations were performed in the wrong color space, prompting the developers to layer a composite blending effect on top to make the colors more vibrant.</p>
<p>For more information, see the <a href="https://en.wikipedia.org/wiki/Blend_modes" target="_blank" rel="noopener noreferrer">Wikipedia article on blend modes</a>, in particular the section about composite <a href="https://en.wikipedia.org/wiki/Blend_modes#Screen" target="_blank" rel="noopener noreferrer">screen blending</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="object-lighting">Object Lighting<a href="#object-lighting" class="hash-link" aria-label="Direct link to Object Lighting" title="Direct link to Object Lighting">​</a></h3>
<p>Scene objects (i.e., RSM model instances) may receive additional lighting when lightmap textures are enabled. The client includes a file called <code>mapobjlighttable.txt</code> that looks like it would be used to control this behavior. However, this mechanism seems to be broken or unused. More research is needed to determine how objects should be lit when the feature is enabled.</p>
<p>Examples: According to said table, object lighting is <strong>enabled</strong> for<code>orcsdun01</code> and <code>orcsdun02</code>, but <strong>disabled</strong> for <code>gef_dun0</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="texture-blending-stages">Texture Blending Stages<a href="#texture-blending-stages" class="hash-link" aria-label="Direct link to Texture Blending Stages" title="Direct link to Texture Blending Stages">​</a></h2>
<p>Projects textures onto the lit geometry (as computed during the lighting stage) in order to cheaply add more detail.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="diffuse-textures">Diffuse Textures<a href="#diffuse-textures" class="hash-link" aria-label="Direct link to Diffuse Textures" title="Direct link to Diffuse Textures">​</a></h3>
<p>Diffuse textures don&#x27;t use the alpha channel directly, but rather adopt a convention where magenta becomes transparent:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">isTransparentBackgroundPixel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">diffuseTextureColor </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> vec4f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">diffuseTextureColor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">r </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">254.0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">255.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> diffuseTextureColor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">g </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3.0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">255.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> diffuseTextureColor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">b </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">254.0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">255.0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><em>Example: A method to determine which background pixels to discard based on the RGBA value (originally proposed by <a href="https://github.com/curio-r" target="_blank" rel="noopener noreferrer">curiosity</a>)</em></p>
<p>This enables the use of simple 256 color bitmaps (stored in <a href="https://en.wikipedia.org/wiki/BMP_file_format" target="_blank" rel="noopener noreferrer">BMP files</a>) for mostly every texture, at the cost of flexibility.</p>
<p>Additionally, texture images are degraded by what appears to be a reduction in <a href="https://en.wikipedia.org/wiki/Color_depth" target="_blank" rel="noopener noreferrer">color depth</a> to 16 bits per pixel:</p>
<p><img decoding="async" loading="lazy" alt="color-banding-example.png" src="/assets/images/color-banding-example-0a0dcf8688267eab9163dbb1750af27b.png" width="739" height="256" class="img_ev3q"></p>
<p><em>Pictured: The use of a smooth gradient demonstrates how textures are rendered with fewer colors inside the game</em></p>
<p>This quantization step is the cause of <a href="https://en.wikipedia.org/wiki/Colour_banding" target="_blank" rel="noopener noreferrer">color banding</a>, which explains the <a href="https://en.wikipedia.org/wiki/Posterization" target="_blank" rel="noopener noreferrer">posterization</a> effect that can be observed on lightmaps.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="lightmap-textures">Lightmap Textures<a href="#lightmap-textures" class="hash-link" aria-label="Direct link to Lightmap Textures" title="Direct link to Lightmap Textures">​</a></h3>
<p>Lightmap textures affect only the terrain (<a href="/rendering/ground-mesh/">ground mesh</a>) directly. Scene decorations may be lit separately (see <a href="#object-lighting">Object Lighting</a>).</p>
<p>The alpha channel encodes an <a href="https://en.wikipedia.org/wiki/Ambient_occlusion" target="_blank" rel="noopener noreferrer">ambient occlusion</a> percentage, while the RGB channel encodes the light contribution of the <a href="#dynamic-lights">dynamic light sources</a> that were used to bake the lightmap texture. Colors lose even more precision due to the alpha channel:</p>
<p><img decoding="async" loading="lazy" alt="posterized-lightmaps-closeup.png" src="data:image/png;base64,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" width="717" height="325" class="img_ev3q"></p>
<p><em>Pictured: The banding effect introduced by downsampling lightmaps to 4 bits per channel can immediately be spotted</em></p>
<p>Each lightmap texture slices include a buffer area (1 pixel wide) that&#x27;s designed to soften the impact of <a href="https://gamedev.stackexchange.com/questions/111704/getting-rid-of-texture-bleeding" target="_blank" rel="noopener noreferrer">texture bleeding</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="vertex-fogging-stage">Vertex Fogging Stage<a href="#vertex-fogging-stage" class="hash-link" aria-label="Direct link to Vertex Fogging Stage" title="Direct link to Vertex Fogging Stage">​</a></h2>
<p>Applies a basic color grading effect to any scene that&#x27;s configured to use fog. If there&#x27;s no fog, this is effectively a NOOP.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="fog-parameters">Fog Parameters<a href="#fog-parameters" class="hash-link" aria-label="Direct link to Fog Parameters" title="Direct link to Fog Parameters">​</a></h3>
<p>The GRF archive includes a list of <a href="https://learn.microsoft.com/en-us/windows/win32/direct3d9/fog-parameters" target="_blank" rel="noopener noreferrer">fog parameters</a> (<code>fogParameterTable.txt</code>), which controls the <a href="https://learn.microsoft.com/en-us/windows/win32/direct3d9/vertex-fog#range-based-fog" target="_blank" rel="noopener noreferrer">range-based vertex fog effect</a>.</p>
<p>This database contains one entry for each map that should use the fog effect. All entries have the following format:</p>
<div class="language-txt codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-txt codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">map_id#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nearLimitPercentage#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">farLimitPercentage#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fogColorARGB#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unusedDensityPercentage#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As an example, consider the fog settings for Payon Cave F0 (<code>pay_dun00</code>):</p>
<div class="language-txt codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-txt codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pay_dun00.rsw#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0.1#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0.9#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xff04009A#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0.3#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This tells the DirectX engine to apply a vertex fog effect using color <code>rgb(4, 0, 154)</code> (<a href="https://learn.microsoft.com/en-us/windows/win32/direct3d9/fog-color" target="_blank" rel="noopener noreferrer">alpha is ignored</a>) that reaches its highest density level at a distance of <code>1490 * 0.9 = 1341</code> world units (<code>268.2</code> if normalized) and is the least dense at a distance of <code>1490 * 0.1 = 149</code> world units (<code>29.8</code> if normalized), where the size of the imagined &quot;fog sphere&quot; is determined by the delta between the camera&#x27;s near and far planes: <code>farPlaneDistance - nearPlaneDistance</code> resulting in <code>1500 - 10 = 1490</code> - see <a href="/rendering/camera-controls/#perspective-projection">Camera Controls</a>.</p>
<p>The density parameter is completely ignored as it&#x27;s used for <a href="https://learn.microsoft.com/en-us/windows/win32/direct3d9/fog-formulas#exponential-fog" target="_blank" rel="noopener noreferrer">exponential mode</a>, but the game only uses <a href="https://learn.microsoft.com/en-us/windows/win32/direct3d9/fog-formulas#linear-fog" target="_blank" rel="noopener noreferrer">linear fog.</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="alpha-composition-stage">Alpha Composition Stage<a href="#alpha-composition-stage" class="hash-link" aria-label="Direct link to Alpha Composition Stage" title="Direct link to Alpha Composition Stage">​</a></h2>
<p>Whenever transparency effects are used, this is the stage that actually computes the result.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="blending-equations">Blending Equations<a href="#blending-equations" class="hash-link" aria-label="Direct link to Blending Equations" title="Direct link to Blending Equations">​</a></h3>
<p>Alpha blending may be performed to render translucent objects on top of the existing scenery (i.e., the game world). This process is highly specific to the type of object being rendered, but much more research is needed to cover the various 2D effects, sprites, etc. So far only the method for rendering water surfaces can be stated here with a high degree of certainty:</p>
<ul>
<li>General blend formula: <code>RGBAsrc × RGBAsrcFactor + RGBAdst × RGBAdstFactor</code> (using <a href="https://gpuweb.github.io/gpuweb/#blend-state" target="_blank" rel="noopener noreferrer">WebGPU</a> terminology)</li>
<li>Color components: <code>RGBAsrc × SrcAlpha + RGBAdst × OneMinusSrcAlpha</code></li>
<li>Alpha component: <code>RGBAsrc × One + RGBAdst × OneMinusSrcAlpha</code></li>
</ul>
<p>Perhaps unsurprisingly, this is the standard <strong>A over B</strong> operator described in the <a href="https://en.wikipedia.org/wiki/Alpha_compositing" target="_blank" rel="noopener noreferrer">Wikipedia article on alpha compositing</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="supported-blend-modes">Supported Blend Modes<a href="#supported-blend-modes" class="hash-link" aria-label="Direct link to Supported Blend Modes" title="Direct link to Supported Blend Modes">​</a></h3>
<p>The following table contains the blend parameters for all blend modes that have been verified so far:</p>
<table><thead><tr><th style="text-align:center">Object Type</th><th style="text-align:center">Component</th><th style="text-align:center">Source Factor</th><th style="text-align:center">Destination Factor</th><th style="text-align:center">Blend Operation</th></tr></thead><tbody><tr><td style="text-align:center">Water Plane</td><td style="text-align:center">Color</td><td style="text-align:center"><code>SrcAlpha</code></td><td style="text-align:center"><code>OneMinusSrcAlpha</code></td><td style="text-align:center"><code>Add</code></td></tr><tr><td style="text-align:center">Water Plane</td><td style="text-align:center">Alpha</td><td style="text-align:center"><code>One</code></td><td style="text-align:center"><code>OneMinusSrcAlpha</code></td><td style="text-align:center"><code>Add</code></td></tr></tbody></table>
<p>Here, <code>Source</code> is the object to be blended (e.g., the water surface) and <code>Destination</code> refers to the existing frame buffer contents.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-note-on-color-spaces">A Note on Color Spaces<a href="#a-note-on-color-spaces" class="hash-link" aria-label="Direct link to A Note on Color Spaces" title="Direct link to A Note on Color Spaces">​</a></h2>
<p>Lighting computations are usually performed on linear colors, even if most output devices expect the result in <a href="https://en.wikipedia.org/wiki/SRGB" target="_blank" rel="noopener noreferrer">sRGB</a> format.</p>
<p>Since textures generally store colors in sRGB format, they need to be gamma-decompressed before use as the result will otherwise be a severely underexposed image. Afterwards, colors would then be sRGB-encoded again before the device can actually display them. This step is called <a href="https://en.wikipedia.org/wiki/Gamma_correction" target="_blank" rel="noopener noreferrer">gamma correction</a> and intended to emulate the characteristics of <a href="https://en.wikipedia.org/wiki/Cathode-ray_tube" target="_blank" rel="noopener noreferrer">CRT monitors</a>.</p>
<p>The RO client, however, doesn&#x27;t seem to be doing any of this. Instead, the sRGB-encoded textures are seemingly used as-is. The lighting computations then fundamentally alter the appearance of the rendered scene by introducing underexposure into the final image, so that darker regions appear more intense. This is alleviated by the <a href="/rendering/scene-lighting/#contrast-correction">tone mapping step</a> added via screen blending.</p>
<p><a href="https://blog.johnnovak.net/2016/09/21/what-every-coder-should-know-about-gamma/" target="_blank" rel="noopener noreferrer">This blog post</a> explains the issue in more detail. With the screen blending effect there&#x27;s no need to perform gamma correction.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2>
<ul>
<li><a href="https://lettier.github.io/3d-game-shaders-for-beginners/gamma-correction.html" target="_blank" rel="noopener noreferrer">OpenGL-specific tutorial that explains gamma correction</a></li>
<li><a href="https://learnopengl.com/Advanced-Lighting/Gamma-Correction" target="_blank" rel="noopener noreferrer">Another OpenGL-based explanation of the gamma correction issue</a></li>
<li><a href="https://www.photoshopessentials.com/photo-editing/layer-blend-modes/screen/" target="_blank" rel="noopener noreferrer">Tutorial explaining the use of the Screen blend mode in Photoshop</a></li>
<li><a href="https://github.com/RagnarokResearchLab/RagLite/blob/0bc2856e2acebcbb568b095853180574a78dc4ba/Core/NativeClient/WebGPU/Shaders/TerrainGeometryShader.wgsl#L138-L171" target="_blank" rel="noopener noreferrer">Implementation of the lighting model - for terrain surfaces only - in WebGPU Shader Language (WGSL)</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/RagnarokResearchLab/ragnarokresearchlab.github.io/edit/main/docs/rendering/scene-lighting.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/rendering/camera-controls/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Camera Controls</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/rendering/animation-systems/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Animation Systems</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#pipeline-stages" class="table-of-contents__link toc-highlight">Pipeline Stages</a></li><li><a href="#input-variables" class="table-of-contents__link toc-highlight">Input Variables</a></li><li><a href="#lighting-stage" class="table-of-contents__link toc-highlight">Lighting Stage</a><ul><li><a href="#directional-light" class="table-of-contents__link toc-highlight">Directional Light</a></li><li><a href="#ambient-light" class="table-of-contents__link toc-highlight">Ambient Light</a></li><li><a href="#dynamic-lights" class="table-of-contents__link toc-highlight">Dynamic Lights</a></li><li><a href="#contrast-correction" class="table-of-contents__link toc-highlight">Contrast Correction</a></li><li><a href="#object-lighting" class="table-of-contents__link toc-highlight">Object Lighting</a></li></ul></li><li><a href="#texture-blending-stages" class="table-of-contents__link toc-highlight">Texture Blending Stages</a><ul><li><a href="#diffuse-textures" class="table-of-contents__link toc-highlight">Diffuse Textures</a></li><li><a href="#lightmap-textures" class="table-of-contents__link toc-highlight">Lightmap Textures</a></li></ul></li><li><a href="#vertex-fogging-stage" class="table-of-contents__link toc-highlight">Vertex Fogging Stage</a><ul><li><a href="#fog-parameters" class="table-of-contents__link toc-highlight">Fog Parameters</a></li></ul></li><li><a href="#alpha-composition-stage" class="table-of-contents__link toc-highlight">Alpha Composition Stage</a><ul><li><a href="#blending-equations" class="table-of-contents__link toc-highlight">Blending Equations</a></li><li><a href="#supported-blend-modes" class="table-of-contents__link toc-highlight">Supported Blend Modes</a></li></ul></li><li><a href="#a-note-on-color-spaces" class="table-of-contents__link toc-highlight">A Note on Color Spaces</a></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/about/">About</a></li><li class="footer__item"><a class="footer__link-item" href="/file-formats/">File Formats</a></li><li class="footer__item"><a class="footer__link-item" href="/rendering/">Rendering</a></li><li class="footer__item"><a class="footer__link-item" href="/game-mechanics/">Game Mechanics</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/contributing/">Contributing</a></li><li class="footer__item"><a href="https://discord.gg/7RFdMNrySy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/RagnarokResearchLab" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/community-projects/">Related Projects</a></li></ul></div><div class="col footer__col"><div class="footer__title">Tools</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/tools/#ebm-export-with-zlib">EBM Export (with zlib)</a></li><li class="footer__item"><a class="footer__link-item" href="/tools/#euc-kr-path-conversion">EUC-KR Path Conversion</a></li><li class="footer__item"><a class="footer__link-item" href="/tools/#raglite-developer-toolkit">RagLite Developer Toolkit</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Ragnarok Research Lab (authors and contributors).<br>All trademarks referenced herein are the properties of their respective owners.</div></div></div></footer></div>
</body>
</html>