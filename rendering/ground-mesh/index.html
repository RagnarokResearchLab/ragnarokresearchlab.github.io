<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-rendering/ground-mesh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<title data-rh="true">Ground Mesh | Ragnarok Research Lab</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ragnarokresearchlab.github.io/rendering/ground-mesh/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Ground Mesh | Ragnarok Research Lab"><meta data-rh="true" name="description" content="This document describes how static terrain can be reconstructed from the GND files used by the Ragnarok Online client."><meta data-rh="true" property="og:description" content="This document describes how static terrain can be reconstructed from the GND files used by the Ragnarok Online client."><link data-rh="true" rel="icon" href="/img/favicon-with-transparency.png"><link data-rh="true" rel="canonical" href="https://ragnarokresearchlab.github.io/rendering/ground-mesh/"><link data-rh="true" rel="alternate" href="https://ragnarokresearchlab.github.io/rendering/ground-mesh/" hreflang="en"><link data-rh="true" rel="alternate" href="https://ragnarokresearchlab.github.io/rendering/ground-mesh/" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.69185b61.css">
<link rel="preload" href="/assets/js/runtime~main.c2bbce5a.js" as="script">
<link rel="preload" href="/assets/js/main.bd455106.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo-with-more-space-around.png" alt="Ragnarok Research Lab Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo-with-more-space-around.png" alt="Ragnarok Research Lab Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Ragnarok Research Lab</b></a><a class="navbar__item navbar__link" href="/about/">About</a><a class="navbar__item navbar__link" href="/file-formats/">File Formats</a><a class="navbar__item navbar__link" href="/rendering/">Rendering</a><a class="navbar__item navbar__link" href="/game-mechanics/">Game Mechanics</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/contributing/">Contribute</a><a href="https://discord.gg/7RFdMNrySy" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/RagnarokResearchLab" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_RiAD"><nav class="menu thin-scrollbar menu_izAj"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/about/">About</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/contributing/">Contributing</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/file-formats/">File Formats</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/rendering/">Rendering</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rendering/">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rendering/coordinate-systems/">Coordinate Systems</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/rendering/ground-mesh/">Ground Mesh</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/game-mechanics/">Game Mechanics</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/arcturus/">Arcturus</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/community-projects/">Community Projects</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/glossary/">Glossary</a></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/">üè†</a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><span class="breadcrumbs__link" itemprop="item name">Rendering</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="item name">Ground Mesh</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Ground Mesh</h1></header><p>This document describes how static terrain can be reconstructed from the GND files used by the Ragnarok Online client.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="static-map-geometry">Static Map Geometry<a class="hash-link" href="#static-map-geometry" title="Direct link to heading">‚Äã</a></h2><p>The ground mesh is a static object that represents the terrain (or &quot;ground&quot;) of each map. It&#x27;s the defining part of the GND file and consists chiefly of geometry to which diffuse textures, color highlights and lightmap textures are applied. This forms the basis of the visual rendition of the game world, onto which ingame actors, effects, and 3D models can be placed.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="relationship-between-gat-and-gnd">Relationship between GAT and GND<a class="hash-link" href="#relationship-between-gat-and-gnd" title="Direct link to heading">‚Äã</a></h2><p>Both files correspond to different parts of a map&#x27;s geometry. See also the following quote:</p><blockquote><p>What you can take away from the RO method, is that they actually use two heightmaps: one invisible heightmap used for collision detection, and a visible one used to draw the map. That way, they can extend the &quot;invisible wall or platforms&quot; around various objects (eg those boats or docks placed in the scene that are not part of the heightmap</p></blockquote><p><em>Source: <a href="https://gamedev.stackexchange.com/questions/25823/how-to-create-a-3d-world-with-2d-sprites-similar-to-ragnorak-online" target="_blank" rel="noopener noreferrer">Game Development @ StackExchange</a></em></p><p>The &quot;collision map&quot; is basically the contents of the GAT file (terrain types and &quot;walkable&quot; flags), while the &quot;height map&quot; is chiefly equivalent to the ground mesh as defined by its height vectors. The server needs to have the GAT information but doesn&#x27;t care about GND, while the client uses GAT information to place units at their correct height and GND files to render the terrain itself.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="ground-mesh-reconstruction">Ground Mesh Reconstruction<a class="hash-link" href="#ground-mesh-reconstruction" title="Direct link to heading">‚Äã</a></h2><p>Recreating the terrain involves a complex set of operations; It&#x27;s stored in a memory-efficient format and therefore not directly compatible with how modern rendering hardware expects 3D objects to be described (see <a href="https://en.wikipedia.org/wiki/Polygon_mesh#Face-vertex_meshes" target="_blank" rel="noopener noreferrer">Face-Vertex Mesh</a>).</p><p>Instead of storing the vertex data directly, individual chunks of terrain (&quot;cubes&quot;) are implicitly described by &quot;height values&quot; that represent the upwards-facing surface geometry as relative position of its corners, offset by the surface cube&#x27;s position in an imaginary &quot;grid&quot; of cubes. To better visualize how the geometry can be reconstructed, it might be helpful to view the terrain as a combination of different (simpler) primitive shapes, which can be &quot;stitched together&quot; to form the ground mesh.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="tiles-cubes-and-surfaces">Tiles, Cubes, and Surfaces<a class="hash-link" href="#tiles-cubes-and-surfaces" title="Direct link to heading">‚Äã</a></h3><p><a href="/rendering/coordinate-systems/#world-coordinates">RO uses tiles as the basic unit of measurement for game logic</a>, but its world actually consists of surfaces larger than that, which are part of what you could call &quot;cubes&quot; (boxes). These boxes are combined like a jigsaw puzzle to form the actual terrain.</p><p>Cubes are defined by only three surfaces:</p><ul><li><code>TOP</code>: Flat or sloped <code>GROUND</code> surface that faces &quot;upwards&quot; if flat, or partially so if angled</li><li><code>NORTH</code>: <code>WALL</code> surface adjacent to the cube&#x27;s <code>GROUND</code> and the neighboring (to the north) cube&#x27;s <code>GROUND</code> surface</li><li><code>EAST</code>: <code>WALL</code> surface adjacent to the cube&#x27;s <code>GROUND</code> and the neighboring (to the east) cube&#x27;s <code>GROUND</code> surface</li></ul><p>In order to create walls to the <code>BOTTOM</code>, <code>SOUTH</code> and <code>WEST</code>, the adjacent cube&#x27;s <code>TOP</code>, <code>NORTH</code> and <code>EAST</code> surface are used, respectively.</p><p>The only two types of surfaces are <code>GROUND</code> and <code>WALL</code>, where <code>GROUND</code> is essentially the square defined by connecting the four height vectors stored in the GND file, and walls are the implied surfaces formed by connecting the <code>GROUND</code> surface of one cube to the <code>GROUND</code> surface of the neighboring cube, forming a wall where they differ in height.</p><p>The distinction between <code>GROUND</code> and <code>WALL</code> surfaces is mostly for illustration purposes; all surfaces are defined by four vertices.</p><p>Each surface of a cube is 2x2 <a href="/file-formats/gat/">GAT</a> tiles large and may be textured or not. Surfaces without textures (i.e., texture ID is <code>-1</code>) aren&#x27;t rendered, nor can they be used to attach &quot;wall&quot; surfaces to from their adjacent cube. This is relevant, because in at least two instances, namely <code>c_tower4</code> and <code>juperos_01</code>, ground surfaces on the map boundaries are erroneously assigned <code>EAST</code> and <code>NORTH</code> surfaces, but you can&#x27;t render walls on map boundaries since there&#x27;s no vertices that they could connect with.</p><p>Surfaces/cubes are combined by &quot;inflating&quot; the flattened cubes in a predefined order (bottom/left to top/right, with new rows starting whenever the &quot;map width&quot; has been exceeded - very much like pixels in a bitmap image). This allows for efficiently reconstructing the ground mesh in a single pass, which is likely to be why the <a href="/file-formats/gnd/">GND</a> format looks the way it does.</p><p>Here&#x27;s an illustration of the above concepts:</p><p><img loading="lazy" alt="GND_HeightVectors.png" src="/assets/images/03-gnd-heightvectors-visualized-6647768dfc1a6d26de077d2743b3faba.png" width="584" height="532" class="img_E7b_"></p><p><em>Points defined by GND height vectors implicitly describe an inflated &quot;cube&quot;.</em></p><p>These then have to be turned into an equivalent representation of the actual geometry:</p><p><img loading="lazy" alt="03-gnd-primitives-visualized.png" src="/assets/images/03-gnd-primitives-visualized-a8a4f1e5d6fa0a7ced0cc8f9016d553a.png" width="584" height="532" class="img_E7b_"></p><p><em>Any surfaces and cubes that are implicitly defined by the height vectors can easily be reconstructed.</em></p><p>As mentioned above, each surface takes up the space of a two-by-two square of GAT tiles. Wall surfaces may span a larger area, but they&#x27;ll appear stretched if the textures mapped to them haven&#x27;t been adjusted, as can be seen in maps like <code>schg_dun01</code>.</p><p>It&#x27;s worth keeping in mind that the &quot;cubes&quot; don&#x27;t have to be literal boxes. Slopes can easily be created by adjusting the heights:</p><p><img loading="lazy" alt="03-gnd-sloped-top.png" src="/assets/images/03-gnd-sloped-top-abc1e17801ea2127ed04efacfa2edb5d.png" width="610" height="529" class="img_E7b_"></p><p><em>Varying the height values assigned to individual corners allows building sloped terrain.</em></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="tiles">Tiles<a class="hash-link" href="#tiles" title="Direct link to heading">‚Äã</a></h4><p>As previously mentioned, <a href="https://en.wikipedia.org/wiki/Tile" target="_blank" rel="noopener noreferrer">tiles</a> are the basic building block for the terrain, so in a way RO could be described as a <a href="https://en.wikipedia.org/wiki/Tile-based_game" target="_blank" rel="noopener noreferrer">tile-based game</a>. It&#x27;s not technically accurate, but that&#x27;s definitely how the end result is perceived. Characters are positioned (at the center) on a tile, map coordinates refer to the tile and everything that requires thinking about positions usually works with the tile as the smallest unit... except when it comes to rendering.</p><p>In practical terms, the actual size of each tile, as rendered on the screen, depends on the scale of the world, camera zoom level and screen resolution. However, it&#x27;s the baseline for measuring distance in the world coordinate system, where one unit of distance can be expressed in &quot;number of tiles&quot;.</p><p>As far as textures are concerned, a texture appears to fit on a single tile if its dimensions are 32 pixels, as can easily be seen by checking the size of the &quot;grid selector&quot; texture rendered on top of the currently selected tile:</p><p><img loading="lazy" alt="03-tile-selector-size.png" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHoAAAA5CAIAAAB296hxAAAABGdBTUEAALGPC/xhBQAAA9JJREFUeNrtmt9LU2EYx2cOBIWFBLaBhqKkF+JCc6GhuNqFYBemNUOhmihpYGr6DwgZemE5mHkjroR24d1CSVM0prnSWHhjXgguFBQlQkFpotB3e2OMwin78TjOng+Hw3P2nnN4/ZzX73nPzmKUyosyhopzZ92B6IJ1k8K6SWHdpLBuUlg3KaybFNZNCusmhXWTwrpJYd2kyAM77OdL13FNF1rjgj/Jwb1fwfxVKpUyBG7CQIC6w00wvjY2Ns+6+8fCYUIK6yYlBGFy+rD2f6CfKJcMPLpJYd2ksG5SWDcpMdJ7E495d8Q+5kTF6C4tLcU18C5lZbe8TUVFRcc1hQPp646Nja2svINieXlZfDIwMKDT6URTS0srCpfL5W0yGAzh60yEPsSHkKOjo/r6OlEnJiYuLX1HoVZfmZycjIuLMxge7u3tYZ/09PTZ2U+iKXydkf7o9qWw8LoobDYb1vv7+7u7u3CNOiXlkmiam3NLz83NdTp/+OYMloqKSrEPIsjh+DY9/TEnJwf/It3d3Wjt7TXGx8f770C06DabzTCCrEDd3/9qYWHetxWajEajzO16bnh4GMXW1hbGvmjt6OgYGRlB0dfXp9frUczMzExNTWVlZY2Pf6itrb1//wE+nJiYwPXz341omZlgtBZ60GpvyDyju6pK723t7HwOayjy86+ur6+jSE5OXlj4iqK5+Ym4AFarVaO5hhuAVlsi8+S+1fouLy9PnKGurm50dOTEvkXL6HY4HCaTqbq6enBwEJvFxcXIAdFUUqIVrtvangrXvqytrYnCZpvBGiNabCKCLJa3ol5ZWRkbe3+abkSLbi8u129RyOXuaYJCoRAJgyiwWCx+DlSpVFivrq6KTVytnp4Xos7IyBAznBOR/sykoKAAIYBQRl7jFtfY+FjmGY+Li4sooCwhIQHF0NAbBAjCQa1WY2fvrDEpKQm5odFoampqZO7c75d5ogapLXOn0DOF4nxTU1N7e/v8/Bdkuv/OSD+7U1NT7fbPvjvAZkPDo+3tbTz+mM2v/z+DTndzZ2dHZLcvXV1dRmMv7quYMorBnpl5GfNIk6mvvLwcmxUVt+12u5++SV83UCpVyFy5PBZRgCw+ODg48STeW6Vef1fEN9ZiyhgM0g8TsLm5gSWwYw8PD51OZ6h6EnW3ylOSlpYmiuzs7BCeNsAw8X3RFfDLszCdk78RZP7Cuklh3aSwblJCMBH85/chIfmNoFTh0U0K6yYlQp8qI/lXrMEgwe9MIhkOE1JYNymsmxTWTQrrJoV1k8K6SWHdpLBuUlg3KayblD9wGHBgxppRfgAAAABJRU5ErkJggg==" width="122" height="57" class="img_E7b_"></p><p>For more details, see <a href="/rendering/coordinate-systems/">Rendering/Coordinate Systems</a>.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="surfaces">Surfaces<a class="hash-link" href="#surfaces" title="Direct link to heading">‚Äã</a></h4><p>Surfaces are larger, visible areas &quot;containing&quot; tiles. The entirety of the map&#x27;s geometry is made out of surfaces, which can be textured or &quot;invisible&quot;. Each surface contains exactly four tiles (two in each dimension).</p><p>This is mostly relevant for texturing, since texture slices usually are 64 pixels wide, so larger surfaces that appear seamless in the game are frequently pieced together by individual surfaces to give the appearance of a continuous textured plane. Surfaces don&#x27;t fit perfectly, which is why there are visible &quot;gaps&quot; in the terrain that can be seen at the right camera angle and distance.</p><p>The vertices forming the terrain&#x27;s surface geometry must be connected from <strong>bottom-right to top-left</strong> for each textured surface. If done the other way around some slopes will turn out to look rather misshapen.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="cubes">Cubes<a class="hash-link" href="#cubes" title="Direct link to heading">‚Äã</a></h4><p>Generally speaking, the terrain is defined by a heightmap indicating the positions of all four corners for any given tile. Each chunk of the terrain (2x2 tiles) is sometimes called cube, which implies the presence of up to 6 surfaces: Two for the top and bottom of the cube, two to either side, and two to the front and back, where of course any number of them could be missing.</p><p>Now, the reason the cube metaphor doesn&#x27;t work perfectly is that each chunk is only defined by <em>three</em> surfaces at most: Top, north, and east. If interpreted as surfaces it doesn&#x27;t really change anything; Since you can express a cube&#x27;s left (or south)-facing side as the adjacent cube&#x27;s right (or north)-facing side you get the same effect with a much leaner data structure.</p><p>In the GND files, you&#x27;ll merely find each corner&#x27;s height and the scale factor, which is enough to render the geometry. You could do this by translating the positions to world coordinates and normalize the heights so they refer to a cube of width and height 1, or just make the cubes bigger to account for the scale factor and then &quot;zoom out&quot; farther to get the same perspective.</p><p>The geometry is then rendered by simply glueing all the surfaces together, and walls are implicitly formed by two tiles that aren&#x27;t on the same height: If there&#x27;s a height difference, put a plane in between the two tiles; this becomes a &quot;wall&quot; if assigning it a texture. However, this is only done if the neighbouring &quot;corners&quot; are higher (or lower) and has a textured surface of its own.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="the-normalizing-scale-factor">The Normalizing Scale Factor<a class="hash-link" href="#the-normalizing-scale-factor" title="Direct link to heading">‚Äã</a></h3><p>The scale of the world, in relation to normalized <a href="/rendering/coordinate-systems/#world-coordinates">world coordinates</a>, is one of the variable fields in later versions of the <a href="/file-formats/gnd/">GND</a> format, but turns out to be a fixed constant in practice. It always takes on the value <code>10</code>, which corresponds to &quot;10 world units per GND cube&quot; and &quot;5 world units per GAT tile&quot;, respectively. The actual calculation appears to be as follows:</p><div class="codeBlockContainer_I0IT language-javascript theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-javascript codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">normalizingScaleFactor </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">GND</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">mapDimensions</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">GAT</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">mapDimensions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">GND</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">geometryScaleFactor</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Since each GND surface always measures two GAT tiles, and the scale factor is seemingly always set to ten, this nets:</p><div class="codeBlockContainer_I0IT language-javascript theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-javascript codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">normalizingScaleFactor </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">5</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Therefore a constant scale factor of <code>1/5</code> should be correct for every map. Applying this factor scales the heights given by the height vectors of the GND file back to the standard coordinate system, with one tile being one world unit large.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="lightmaps">Lightmaps<a class="hash-link" href="#lightmaps" title="Direct link to heading">‚Äã</a></h2><p>Dynamic light sources are present in each map&#x27;s RSW file. In order to improve rendering performance on devices of the time, the game actually doesn&#x27;t use these directly. Instead, it looks like the scene lighting is precomputed from these light sources, and rendered to a texture - a process which is called baking. The GND file for each map contains the resulting bitmaps:</p><ul><li>A lightmap texture, frequently called &quot;colormap&quot;, for colored lighting</li><li>An ambient occlusion texture, frequently called &quot;shadowmap&quot;, for shadows</li></ul><p>Lightmaps add static light and shadow detail to each map, without requiring the client to calculate lighting in real time.</p><p>Similarly to the terrain&#x27;s surface itself, the lightmap texture is sliced into unique parts, and each part must be mapped to the right surface on the assembled ground mesh. Which lightmap &quot;slice&quot; to map to the given terrain surface is defined by an implicit process of performing lookups in the following order: <code>GND cube -&gt; GND surface -&gt; lightmap slice -&gt; pixel data (RGBA)</code></p><p>The process for mapping slices to surfaces is therefore similar to how the actual terrain is formed: Each surface references a slice of the lightmap texture, as well as a part of the regular (diffuse) texture, while each cube references up to three surfaces.</p><p>The ambient occlusion values are stored in the same format as specularity values, with &quot;white&quot; pixels representing areas where no ambient occlusion (i.e., no &quot;shadows&quot;) should be rendered. Lightmaps themselves don&#x27;t have transparency values.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="ambient-occlusion-shadows">Ambient Occlusion (&quot;Shadows&quot;)<a class="hash-link" href="#ambient-occlusion-shadows" title="Direct link to heading">‚Äã</a></h3><p>It bears repeating that there isn&#x27;t a single lightmap texture, but rather two: A &quot;color map&quot; that contains static lighting, and a &quot;shadow map&quot; that contains only greyscale data and is used to render shadows. The latter effectively stores the <a href="https://en.wikipedia.org/wiki/Ambient_occlusion" target="_blank" rel="noopener noreferrer">ambient occlusion</a> percentage for each pixel.</p><p>The &quot;shadow map&quot; must be applied after the lighting calculation to avoid having it blended in with the other light sources, which would cause shadows to appear &quot;washed out&quot; or even invisible, depending on when in the lighting process the colors are multiplied with the shadow/alpha values.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="buffer-areas-and-texture-bleeding">Buffer Areas and Texture Bleeding<a class="hash-link" href="#buffer-areas-and-texture-bleeding" title="Direct link to heading">‚Äã</a></h3><p>There&#x27;s one more issue that has clearly affected the design of the lightmap format: Texture bleeding. If all the tiny slices were to be combined seamlessly, there could be visible artifacts from texture bleeding as soon as linear filtering is enabled.</p><p>To avoid this problem, a one-pixel area at the outside of each texture slice is present, which isn&#x27;t used directly. It serves to provide a buffer between the adjacent slices and removes or at least reduces the effect when texture filtering is applied.</p><p>In this image you can see how two adjacent slices might be merged:</p><p><img loading="lazy" alt="03-gnd-lightmap-bufferareas.png" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAABACAIAAABdtOgoAAAAB3RJTUUH5gUOEQg6N8cwgQAAAAlwSFlzAAALMgAACzIBQPVfaAAAAARnQU1BAACxjwv8YQUAAAGYSURBVHja7dwxSgNBGEBhN1gIunqAeAS7WFvY2HgNUQK6GNAiQiBNyoCVp7DxHvEOwQvkArvRA/x/MWB4C3lfutnZdcJjIZMNVqMDkQb0AvadAWAGgBkAZgCYAWAGgB1mBy4+7oou9Phwv9OFjlZl81c92+Bk6/cOgBkAZgCYAWAGgBkAZgBYug/4Wa/jA1U8/Dp9C8eH58NwvBmP6ffeC94BMAPADAAzAMwAMAPADACrsq/Nj1+uyy6UbBCqKjsjbl+f1eH41800HJ8vFuH47Wc8n+LzgJ4yAMwAMAPADAAzAMwAsHQfcPR8FZ+QXSg7Mkg3AumVIpereHz794p8j+L59elJOD6fzQrXWcZ9QE8ZAGYAmAFgBoAZAGYAWPq7oG3bxuPZCdkX/13pc4JY22YnbIvmbzabcLyZTIrW875clr2BhHcAzAAwA8AMADMAzAAwA8DSfUDXdf/zF0o/8GfraXc7P1tntvqnpim6vM8DesoAMAPADAAzAMwAMAPAqp79W5294x0AMwDMADADwAwAMwDMALBfVCkzJPSu+o0AAAAASUVORK5CYII=" width="128" height="64" class="img_E7b_"></p><p>The green area marks the visible portion of each slice that is contained within the area defined by the texture coordinates, with the area outside being the &quot;buffer&quot; that&#x27;s blended with its adjacent texels when texture bleeding occurs.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="posterization-effect">Posterization Effect<a class="hash-link" href="#posterization-effect" title="Direct link to heading">‚Äã</a></h3><p>The client reduces the number of colors when processing the lightmap texture, causing visible artifacts. These aren&#x27;t part of the lightmap itself, but rather introduced deliberately when loading the texture - presumably for stylistic reasons.</p><p>The effect is achieved by applying the following operation to the RGB values:</p><blockquote></blockquote><div class="codeBlockContainer_I0IT language-c theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-c codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    r </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> LEVEL_COUNT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> LEVEL_COUNT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    g </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">g </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> LEVEL_COUNT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> LEVEL_COUNT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    b </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> LEVEL_COUNT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> LEVEL_COUNT</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><blockquote><p>In RO, LEVEL_COUNT is 16. For javascript it would be</p></blockquote><div class="codeBlockContainer_I0IT language-javascript theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-javascript codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">c </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">floor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">LEVEL_COUNT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">LEVEL_COUNT</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; where c is each color component</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><em>Source: greenboxal (Hercules/rathena forums)</em></p><p>This effectively reduces the amount of visible colors, thereby introducing the &quot;jagged&quot; transitions in the color gradient.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="color-highlights-vertex-colors">Color Highlights (Vertex Colors)<a class="hash-link" href="#color-highlights-vertex-colors" title="Direct link to heading">‚Äã</a></h2><p>In order to give highlights to the terrain without requiring vast amounts of ever-so slightly different textures, the client can render specific (solid) colors at the corners of each tile to give this corner (and all adjacent ones) a different hue:</p><blockquote><p>Each tile can have a diffuse color. This color, however, is not being applied to all four corners of a tile, but only to the bottom left vertex and all vertices that share the same coordinate.</p></blockquote><p>Source: <a href="https://rathena.org/board/topic/57955-custom-ragnarok-online-client/" target="_blank" rel="noopener noreferrer">Shinryo, as posted on the rAthena forums</a></p><p>This concept is known as <a href="https://gamedev.stackexchange.com/questions/139059/what-is-a-vertex-color" target="_blank" rel="noopener noreferrer">vertex colors</a> and it works by submitting additional information for a given vertex, which is then used by the graphics hardware to color it differently. It was widely used in older games where dynamic lighting wasn&#x27;t feasible due to technical limitations, and it can have a significant visual impact for barely any effort at all.</p><p>This vertex color should be applied to the bottom left corner (vertex) of each tile and the vertices of all adjacent tiles that happen to be in the same position. With this, one can define colored spots for all corners of the tile grid with little overhead.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="references">References<a class="hash-link" href="#references" title="Direct link to heading">‚Äã</a></h2><ul><li><a href="http://web.archive.org/web/20071015031008/http://www.neatocool.com/Projects/Ragnarok/Map_Editors_Text/" target="_blank" rel="noopener noreferrer">An intuitive explanation of the terrain in RO</a> (archived; the screenshots are unfortunately missing)</li><li><a href="https://playground.babylonjs.com/#J48BT5#2" target="_blank" rel="noopener noreferrer">This online demo</a> showing GND-style cube geometry defined in a standardized vertex data format</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/RagnarokResearchLab/ragnarokresearchlab.github.io/edit/main/docs/rendering/03-ground-mesh.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/rendering/coordinate-systems/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Coordinate Systems</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/game-mechanics/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Overview</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#static-map-geometry" class="table-of-contents__link toc-highlight">Static Map Geometry</a></li><li><a href="#relationship-between-gat-and-gnd" class="table-of-contents__link toc-highlight">Relationship between GAT and GND</a></li><li><a href="#ground-mesh-reconstruction" class="table-of-contents__link toc-highlight">Ground Mesh Reconstruction</a><ul><li><a href="#tiles-cubes-and-surfaces" class="table-of-contents__link toc-highlight">Tiles, Cubes, and Surfaces</a></li><li><a href="#the-normalizing-scale-factor" class="table-of-contents__link toc-highlight">The Normalizing Scale Factor</a></li></ul></li><li><a href="#lightmaps" class="table-of-contents__link toc-highlight">Lightmaps</a><ul><li><a href="#ambient-occlusion-shadows" class="table-of-contents__link toc-highlight">Ambient Occlusion (&quot;Shadows&quot;)</a></li><li><a href="#buffer-areas-and-texture-bleeding" class="table-of-contents__link toc-highlight">Buffer Areas and Texture Bleeding</a></li><li><a href="#posterization-effect" class="table-of-contents__link toc-highlight">Posterization Effect</a></li></ul></li><li><a href="#color-highlights-vertex-colors" class="table-of-contents__link toc-highlight">Color Highlights (Vertex Colors)</a></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/about/">About</a></li><li class="footer__item"><a class="footer__link-item" href="/file-formats/">File Formats</a></li><li class="footer__item"><a class="footer__link-item" href="/rendering/">Rendering</a></li><li class="footer__item"><a class="footer__link-item" href="/game-mechanics/">Game Mechanics</a></li><li class="footer__item"><a class="footer__link-item" href="/glossary/">Glossary</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/contributing/">Contributing</a></li><li class="footer__item"><a href="https://discord.gg/7RFdMNrySy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/RagnarokResearchLab" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Tools</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/tools/">Coming Soon‚Ñ¢</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2023 Ragnarok Research Lab (authors and contributors).<br>All trademarks referenced herein are the properties of their respective owners.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.c2bbce5a.js"></script>
<script src="/assets/js/main.bd455106.js"></script>
</body>
</html>